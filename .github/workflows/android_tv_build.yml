name: Build Android TV Only

on:
  workflow_dispatch: # ä»…å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  build-android:
    runs-on: ubuntu-latest # ä½¿ç”¨ Ubuntu ç¼–è¯‘ Android æ•ˆç‡æ›´é«˜
    permissions:
      contents: read # åªéœ€è¦è¯»å–ä»£ç æƒé™

    steps:
      # 1. ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è¿˜åŸç­¾åæ–‡ä»¶ (åˆ©ç”¨ä½ é…ç½®çš„ Secrets)
      - name: Download Android keystore
        id: android_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: keystore.jks
          encodedString: ${{ secrets.KEYSTORE_BASE64 }}

      # 3. ç”Ÿæˆ key.properties ä¾› Gradle è¯»å–
      # è¿™é‡Œä¼šè‡ªåŠ¨æŠŠä½ çš„å¯†ç æ³¨å…¥åˆ°ç¼–è¯‘é…ç½®ä¸­
      - name: Create key.properties
        run: |
          echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" > simple_live_app/android/key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> simple_live_app/android/key.properties

      # 4. è®¾ç½® JAVA ç¯å¢ƒ (ä¿æŒåŸé¡¹ç›®ç”¨çš„ Java 21)
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "21"
          cache: "gradle"

      # 5. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Flutter action
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: simple_live_app/pubspec.yaml # è·Ÿéšé¡¹ç›®åŸæœ¬çš„ç‰ˆæœ¬
          cache: true

      # 6. ä¸‹è½½ä¾èµ–
      - name: Restore packages
        run: |
          cd simple_live_app
          flutter pub get

      # 7. æ‰“åŒ… APK (å…³é”®æ­¥éª¤)
      # --split-per-abi ä¼šç”Ÿæˆé’ˆå¯¹ä¸åŒæ¶æ„çš„åŒ…ï¼Œå‡å°ä½“ç§¯
      # Android TV é€šå¸¸æ˜¯ armeabi-v7a (è€ç”µè§†) æˆ– arm64-v8a (æ–°ç”µè§†)
      - name: Build APK
        run: |
          cd simple_live_app
          flutter build apk --release --split-per-abi

      # 8. ä¸Šä¼ ç¼–è¯‘ç»“æœä¾›ä¸‹è½½
      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-tv-apks
          path: |
            simple_live_app/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            simple_live_app/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          # æ³¨æ„ï¼šæˆ‘å»æ‰äº† x86_64ï¼Œå› ä¸ºç”µè§†åŸºæœ¬ä¸ç”¨è¿™ä¸ªæ¶æ„ï¼Œåªä¿ç•™ v7a å’Œ v8a å³å¯

      - run: echo "ğŸ Build finished successfully!"
